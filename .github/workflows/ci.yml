name: ci

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Install CI deps
        run: |
          python -m pip install --upgrade pip wheel
          if (Test-Path "requirements-ci.txt") {
            pip install -r requirements-ci.txt
          } else {
            pip install pandas numpy evidently
          }

      - name: Show workspace + data
        run: |
          echo "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          ls
          if (Test-Path "data") { Get-ChildItem -Recurse -Force data | Select-Object FullName }

      - name: Run validation dry-run
        run: |
          python shared_env/scripts/validate_sample_evidently.py

  fraud-api-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (API)
        run: |
          pip install fastapi uvicorn[standard] requests joblib pandas pydantic shap pytest pyyaml xgboost scikit-learn

      - name: Health check artifacts (UTF-8)
        run: |
          python -X utf8 shared_env/scripts/health_checks_stage4_fraud_api.py

      - name: Detect API port from run_api.py (default 8001)
        id: detect_port
        run: |
          $txt = Get-Content "fraud_detection_system/api/run_api.py" -Raw
          $m = [regex]::Match($txt, 'port\s*=\s*(\d+)')
          if ($m.Success) { $port = [int]$m.Groups[1].Value } else { $port = 8001 }
          "port=$port" | Out-File -FilePath api_port.txt -Encoding ascii
          Write-Host "Using port $port"

      - name: Launch API (background with logs)
        id: launch_api
        run: |
          $env:PYTHONUNBUFFERED = "1"
          $args = "fraud_detection_system/api/run_api.py"
          $p = Start-Process -FilePath "python" -ArgumentList $args -PassThru -NoNewWindow `
               -RedirectStandardOutput api_stdout.txt -RedirectStandardError api_stderr.txt
          "pid=$($p.Id)" | Out-File -FilePath api_pid.txt -Encoding ascii
          Start-Sleep -Seconds 1
          if ($p.HasExited) {
            Write-Host "API process exited early with code $($p.ExitCode)"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to start"
          }

      - name: Wait for startup line (up to 120s)
        run: |
          $deadline = (Get-Date).AddSeconds(120)
          $ready = $false
          while ((Get-Date) -lt $deadline) {
            $stderr = if (Test-Path api_stderr.txt) { Get-Content api_stderr.txt -Raw -ErrorAction SilentlyContinue } else { "" }
            $stdout = if (Test-Path api_stdout.txt) { Get-Content api_stdout.txt -Raw -ErrorAction SilentlyContinue } else { "" }
            if ($stderr -match "Application startup complete." -or $stdout -match "Application startup complete.") {
              $ready = $true; break
            }
            Start-Sleep -Seconds 1
          }
          if (-not $ready) {
            Write-Host "Timed out waiting for 'Application startup complete.'"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API did not report startup completion."
          }
          Write-Host "API startup line detected."

      # Optional: non-fatal /score ping (comment out if you prefer pure log-based smoke)
      - name: Best-effort /score ping (non-blocking)
        run: |
          try {
            $port = (Get-Content api_port.txt) -replace 'port=',''
            $payload = '{"amount":120.5,"account_age_days":200,"country":"US","device_id":"D_A","hour_of_day":20}'
            $resp = Invoke-WebRequest -Uri "http://127.0.0.1:$port/score" -Method POST -Body $payload -ContentType "application/json" -TimeoutSec 10 -ErrorAction Stop
            $resp.Content | Out-File -FilePath score_resp.json -Encoding utf8
            Write-Host "Score HTTP $($resp.StatusCode)"
          } catch {
            Write-Host "WARN: /score ping failed (non-blocking). $($_.Exception.Message)"
          }

      - name: Stop API (always)
        if: always()
        run: |
          if (Test-Path api_pid.txt) {
            $apiPid = ((Get-Content api_pid.txt) -replace 'pid=','')
            Try { Stop-Process -Id $apiPid -Force -ErrorAction SilentlyContinue } Catch {}
            Remove-Item api_pid.txt -ErrorAction SilentlyContinue
          }
          if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
          if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }

      - name: Upload API logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fraud-api-logs
          path: |
            api_stdout.txt
            api_stderr.txt
            api_pid.txt
            api_port.txt
            score_resp.json
          if-no-files-found: ignore
          retention-days: 7

  stage5-monitor-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install deps (monitoring)
        run: |
          python -m pip install --upgrade pip wheel
          pip install pandas numpy matplotlib evidently mlflow

      - name: Credit monitor (dry)
        run: |
          python shared_env/monitoring/monitor_credit_drift.py --dry-run

      - name: Fraud monitor (dry)
        run: |
          python shared_env/monitoring/monitor_fraud_api_logs.py --dry-run

      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artifacts
          path: |
            docs_global/monitoring/**/*
          if-no-files-found: ignore
          retention-days: 7
  # .github/workflows/ci.yml (append this job)
  reporting-smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install minimal deps for reporting
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pandas nbconvert nbformat jupyter mlflow
      - name: Run daily reports in dry-run
        shell: pwsh
        run: |
          $env:PYTHONPATH = "$pwd"
          # Use a local mlruns so MLflow calls (if any) don't error
          $env:MLFLOW_TRACKING_URI = "file:///$((Get-Location).Path.Replace('\','/'))/mlruns"
          python fraud_detection_system/reports/run_daily_fraud_report.py --dry-run
          python credit_scoring_system/reports/run_daily_credit_report.py --dry-run
      - name: Upload reporting artifacts (best-effort)
        uses: actions/upload-artifact@v4
        with:
          name: stage7-reporting-smoke
          path: docs_global/reports/**
          if-no-files-found: warn
  
  unit-min:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - name: Install pytest + pandas
        run: |
          python -m pip install --upgrade pip
          pip install pytest pandas
      - name: Run minimal unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q shared_env/tests
          
  data-contract-smoke:
    runs-on: windows-latest
    continue-on-error: true  # promote later if desired
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow
      - name: Validate contracts
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python shared_env/contracts/validate_credit_outputs.py
          python shared_env/contracts/validate_fraud_logs.py
        
  api-http-integration:
    runs-on: windows-latest
    continue-on-error: true  # keep non-blocking until stable
    env:
      PYTHONPATH: ${{ github.workspace }}  # ensure packages resolve in child procs too
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install "fastapi==0.116.*" "uvicorn==0.35.*" pydantic requests pandas joblib xgboost pyyaml

      - name: Start Fraud API (background, no reload)
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          $cmd = "python -m uvicorn fraud_detection_system.api.app:app --host 127.0.0.1 --port 8001 --log-level info --no-access-log"
          Start-Process -FilePath "pwsh" -ArgumentList "-NoProfile","-Command",$cmd `
            -NoNewWindow `
            -RedirectStandardOutput "$ws\api_stdout.txt" `
            -RedirectStandardError "$ws\api_stderr.txt" `
            -WorkingDirectory "$ws"
          Start-Sleep -Seconds 10

      - name: Probe /health and /openapi.json (Python, proxy-proof)
        shell: pwsh
        run: |
          $script = @'
      import os, sys, time, requests
      base = "http://127.0.0.1:8001"
      s = requests.Session()
      s.trust_env = False  # ignore any proxy env on runner
      deadline = time.time() + 60
      ok = False
      last_exc = None
      while time.time() < deadline:
          try:
              r = s.get(base + "/health", timeout=4)
              print("HEALTH:", r.status_code, r.text[:200])
              if 200 <= r.status_code < 300:
                  ok = True
                  break
          except Exception as e:
              last_exc = e
          time.sleep(2)
      if not ok:
          print("Health probe failed.")
          if last_exc: print("LAST_ERR:", last_exc)
          sys.exit(1)
      o = s.get(base + "/openapi.json", timeout=6)
      print("OPENAPI:", o.status_code, "bytes:", len(o.content))
      '@
          Set-Content -Path ci_probe.py -Value $script -Encoding UTF8
          python ci_probe.py
        

      - name: Upload API logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-logs
          path: |
            api_stdout.txt
            api_stderr.txt

