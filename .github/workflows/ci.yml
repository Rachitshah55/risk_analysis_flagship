name: ci

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Install CI deps
        run: |
          python -m pip install --upgrade pip wheel
          if (Test-Path "requirements-ci.txt") {
            pip install -r requirements-ci.txt
          } else {
            pip install pandas numpy evidently
          }

      - name: Show workspace + data
        run: |
          echo "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          ls
          if (Test-Path "data") { Get-ChildItem -Recurse -Force data | Select-Object FullName }

      - name: Run validation dry-run
        run: |
          python shared_env/scripts/validate_sample_evidently.py

  fraud-api-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (API)
        run: |
          pip install fastapi uvicorn[standard] requests joblib pandas pydantic shap pytest pyyaml xgboost scikit-learn

      - name: Health check artifacts (UTF-8)
        run: |
          python -X utf8 shared_env/scripts/health_checks_stage4_fraud_api.py

      - name: Detect API port from run_api.py (default 8001)
        id: detect_port
        run: |
          $txt = Get-Content "fraud_detection_system/api/run_api.py" -Raw
          $m = [regex]::Match($txt, 'port\s*=\s*(\d+)')
          if ($m.Success) { $port = [int]$m.Groups[1].Value } else { $port = 8001 }
          "port=$port" | Out-File -FilePath api_port.txt -Encoding ascii
          Write-Host "Using port $port"

      - name: Launch API (background with logs)
        id: launch_api
        run: |
          $env:PYTHONUNBUFFERED = "1"
          $args = "fraud_detection_system/api/run_api.py"
          $p = Start-Process -FilePath "python" -ArgumentList $args -PassThru -NoNewWindow `
               -RedirectStandardOutput api_stdout.txt -RedirectStandardError api_stderr.txt
          "pid=$($p.Id)" | Out-File -FilePath api_pid.txt -Encoding ascii
          Start-Sleep -Seconds 1
          if ($p.HasExited) {
            Write-Host "API process exited early with code $($p.ExitCode)"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to start"
          }

      - name: Wait for startup line (up to 120s)
        run: |
          $deadline = (Get-Date).AddSeconds(120)
          $ready = $false
          while ((Get-Date) -lt $deadline) {
            $stderr = if (Test-Path api_stderr.txt) { Get-Content api_stderr.txt -Raw -ErrorAction SilentlyContinue } else { "" }
            $stdout = if (Test-Path api_stdout.txt) { Get-Content api_stdout.txt -Raw -ErrorAction SilentlyContinue } else { "" }
            if ($stderr -match "Application startup complete." -or $stdout -match "Application startup complete.") {
              $ready = $true; break
            }
            Start-Sleep -Seconds 1
          }
          if (-not $ready) {
            Write-Host "Timed out waiting for 'Application startup complete.'"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API did not report startup completion."
          }
          Write-Host "API startup line detected."

      # Optional: non-fatal /score ping (comment out if you prefer pure log-based smoke)
      - name: Best-effort /score ping (non-blocking)
        run: |
          try {
            $port = (Get-Content api_port.txt) -replace 'port=',''
            $payload = '{"amount":120.5,"account_age_days":200,"country":"US","device_id":"D_A","hour_of_day":20}'
            $resp = Invoke-WebRequest -Uri "http://127.0.0.1:$port/score" -Method POST -Body $payload -ContentType "application/json" -TimeoutSec 10 -ErrorAction Stop
            $resp.Content | Out-File -FilePath score_resp.json -Encoding utf8
            Write-Host "Score HTTP $($resp.StatusCode)"
          } catch {
            Write-Host "WARN: /score ping failed (non-blocking). $($_.Exception.Message)"
          }

      - name: Stop API (always)
        if: always()
        run: |
          if (Test-Path api_pid.txt) {
            $apiPid = ((Get-Content api_pid.txt) -replace 'pid=','')
            Try { Stop-Process -Id $apiPid -Force -ErrorAction SilentlyContinue } Catch {}
            Remove-Item api_pid.txt -ErrorAction SilentlyContinue
          }
          if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
          if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }

      - name: Upload API logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fraud-api-logs
          path: |
            api_stdout.txt
            api_stderr.txt
            api_pid.txt
            api_port.txt
            score_resp.json
          if-no-files-found: ignore
          retention-days: 7

  stage5-monitor-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install deps (monitoring)
        run: |
          python -m pip install --upgrade pip wheel
          pip install pandas numpy matplotlib evidently mlflow

      - name: Credit monitor (dry)
        run: |
          python shared_env/monitoring/monitor_credit_drift.py --dry-run

      - name: Fraud monitor (dry)
        run: |
          python shared_env/monitoring/monitor_fraud_api_logs.py --dry-run

      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artifacts
          path: |
            docs_global/monitoring/**/*
          if-no-files-found: ignore
          retention-days: 7
  # .github/workflows/ci.yml (append this job)
  reporting-smoke:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install minimal deps for reporting
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pandas nbconvert nbformat jupyter mlflow
      - name: Run daily reports in dry-run
        shell: pwsh
        run: |
          $env:PYTHONPATH = "$pwd"
          # Use a local mlruns so MLflow calls (if any) don't error
          $env:MLFLOW_TRACKING_URI = "file:///$((Get-Location).Path.Replace('\','/'))/mlruns"
          python fraud_detection_system/reports/run_daily_fraud_report.py --dry-run
          python credit_scoring_system/reports/run_daily_credit_report.py --dry-run
      - name: Upload reporting artifacts (best-effort)
        uses: actions/upload-artifact@v4
        with:
          name: stage7-reporting-smoke
          path: docs_global/reports/**
          if-no-files-found: warn
  
  unit-min:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - name: Install pytest + pandas
        run: |
          python -m pip install --upgrade pip
          pip install pytest pandas
      - name: Run minimal unit tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest -q shared_env/tests
          
  data-contract-smoke:
    runs-on: windows-latest
    continue-on-error: true  # promote later if desired
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas pyarrow
      - name: Validate contracts
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python shared_env/contracts/validate_credit_outputs.py
          python shared_env/contracts/validate_fraud_logs.py
        
  api-http-integration:
    runs-on: windows-latest
    continue-on-error: true  # keep non-blocking until stable
    env:
      PYTHONPATH: ${{ github.workspace }}  # ensure packages resolve in child procs too
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }

      - name: Install minimal deps
        run: |
          python -m pip install --upgrade pip
          pip install "fastapi==0.116.*" "uvicorn==0.35.*" pydantic requests pandas joblib xgboost pyyaml

      - name: Start Fraud API (background, no reload)
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          $cmd = "python -m uvicorn fraud_detection_system.api.app:app --host 127.0.0.1 --port 8001 --log-level info --no-access-log"
          Start-Process -FilePath "pwsh" -ArgumentList "-NoProfile","-Command",$cmd `
            -NoNewWindow `
            -RedirectStandardOutput "$ws\api_stdout.txt" `
            -RedirectStandardError "$ws\api_stderr.txt" `
            -WorkingDirectory "$ws"
          Start-Sleep -Seconds 10

      - name: Start + Probe Fraud API (single PowerShell step)
        shell: pwsh
        run: |
          $ws = "${{ github.workspace }}"
          $env:PYTHONPATH = $ws
  
          # Start Uvicorn in background, capture PID and logs
          $args = "-m uvicorn fraud_detection_system.api.app:app --host 127.0.0.1 --port 8001 --log-level info --no-access-log"
          $p = Start-Process -FilePath "python" -ArgumentList $args `
                -WorkingDirectory $ws -NoNewWindow -PassThru `
                -RedirectStandardOutput "$ws\api_stdout.txt" `
                -RedirectStandardError "$ws\api_stderr.txt"
  
          # Give it a moment to bind
          Start-Sleep -Seconds 3
  
          # Probe /health with retries (max ~60s)
          $uri = "http://127.0.0.1:8001/health"
          $deadline = (Get-Date).AddSeconds(60)
          $ok = $false
          while ((Get-Date) -lt $deadline) {
            try {
              $r = Invoke-WebRequest -Uri $uri -UseBasicParsing -TimeoutSec 4
              Write-Host "HEALTH $($r.StatusCode) $($r.Content.Substring(0, [Math]::Min(200, $r.Content.Length)))"
              if ($r.StatusCode -ge 200 -and $r.StatusCode -lt 300) { $ok = $true; break }
            } catch {
              Start-Sleep -Seconds 2
            }
            if ($p.HasExited) { break }
          }
  
          if (-not $ok) {
            Write-Host "--- api_stdout.txt (tail) ---"
            if (Test-Path "$ws\api_stdout.txt") { Get-Content "$ws\api_stdout.txt" -Tail 200 -ErrorAction SilentlyContinue }
            Write-Host "--- api_stderr.txt (tail) ---"
            if (Test-Path "$ws\api_stderr.txt") { Get-Content "$ws\api_stderr.txt" -Tail 200 -ErrorAction SilentlyContinue }
            try { if (-not $p.HasExited) { Stop-Process -Id $p.Id -Force } } catch {}
            throw "Health probe failed"
          }
  
          # Quick OpenAPI check
          try {
            $o = Invoke-WebRequest -Uri "http://127.0.0.1:8001/openapi.json" -UseBasicParsing -TimeoutSec 6
            Write-Host "OPENAPI $($o.StatusCode) bytes $(($o.Content | Out-String).Length)"
          } catch {
            Write-Host "OPENAPI probe failed: $_"
            try { if (-not $p.HasExited) { Stop-Process -Id $p.Id -Force } } catch {}
            throw
          }
  
          # Stop server cleanly
          try { if (-not $p.HasExited) { Stop-Process -Id $p.Id -Force } } catch {}
    
       
      - name: Upload API logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-logs
          path: |
            api_stdout.txt
            api_stderr.txt

  http-integration:
    name: http-integration (non-blocking)
    runs-on: windows-latest
    continue-on-error: true
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.13' }
      - name: Install deps (requests only)
        run: pip install requests
      - name: Boot Fraud API (no reload)
        shell: pwsh
        run: |
          $env:MLFLOW_TRACKING_URI="file:///$((Resolve-Path mlruns).Path)"
          python fraud_detection_system/api/run_api.py | Tee-Object api_stdout.txt
        continue-on-error: true
      - name: Probe endpoints
        if: always()
        shell: python
        run: |
          import os, time, requests
          s = requests.Session(); s.trust_env=False
          ok=False
          for _ in range(30):
            try:
              r = s.get("http://127.0.0.1:8001/health", timeout=2)
              if r.ok:
                ok=True; break
            except Exception: time.sleep(1)
          print("health_ok=", ok)
          if ok:
            resp = s.post("http://127.0.0.1:8001/score", json={"amount":120.5,"account_age_days":200,"country":"US","device_id":"D_A","hour_of_day":20}, timeout=3)
            print("score_status=", resp.status_code, "keys=", list(resp.json().keys()))
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: http-integration-logs
          path: |
            api_stdout.txt
            fraud_detection_system/api/logs/**.jsonl

  # Make reporting-smoke a gating step by ordering (branch protection should also mark it required)
  gate-reporting:
    name: reporting gate
    runs-on: windows-latest
    needs: [validate, stage5-monitor-smoke, fraud-api-smoke, http-integration, reporting-smoke]
    steps:
      - run: echo "All upstream jobs finished. Enforce required status via branch protection."


