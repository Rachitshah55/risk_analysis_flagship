name: ci

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Install CI deps
        run: |
          python -m pip install --upgrade pip wheel
          if (Test-Path "requirements-ci.txt") {
            pip install -r requirements-ci.txt
          } else {
            pip install pandas numpy evidently
          }

      - name: Show workspace + data
        run: |
          echo "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          ls
          if (Test-Path "data") { Get-ChildItem -Recurse -Force data | Select-Object FullName }

      - name: Run validation dry-run
        run: |
          python shared_env/scripts/validate_sample_evidently.py

  fraud-api-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
      # Set to "1" to fail on /score schema errors (HTTP 422). Keep "0" while stabilizing.
      STRICT_API_SMOKE: "0"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (API)
        run: |
          pip install fastapi uvicorn[standard] requests joblib pandas pydantic shap pytest pyyaml xgboost scikit-learn

      - name: Health check artifacts (UTF-8)
        run: |
          python -X utf8 shared_env/scripts/health_checks_stage4_fraud_api.py

      - name: Launch API (background with logs)
        id: launch_api
        run: |
          $env:PYTHONUNBUFFERED = "1"
          $args = "fraud_detection_system/api/run_api.py"
          $p = Start-Process -FilePath "python" -ArgumentList $args -PassThru -NoNewWindow `
               -RedirectStandardOutput api_stdout.txt -RedirectStandardError api_stderr.txt
          "pid=$($p.Id)" | Out-File -FilePath api_pid.txt -Encoding ascii
          Start-Sleep -Seconds 1
          if ($p.HasExited) {
            Write-Host "API process exited early with code $($p.ExitCode)"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to start"
          }

      - name: Detect API port from run_api.py (default 8001)
        id: detect_port
        run: |
          $txt = Get-Content "fraud_detection_system/api/run_api.py" -Raw
          $m = [regex]::Match($txt, 'port\s*=\s*(\d+)')
          if ($m.Success) { $port = [int]$m.Groups[1].Value } else { $port = 8001 }
          "port=$port" | Out-File -FilePath api_port.txt -Encoding ascii
          Write-Host "Using port $port"

      - name: Wait for readiness (up to 90s; /health OR /openapi.json)
        run: |
          $apiPid = ((Get-Content api_pid.txt) -replace 'pid=','')
          $port = (Get-Content api_port.txt) -replace 'port=',''
          $ok = $false
          for ($i=0; $i -lt 90; $i++) {
            $ready = $false
            try {
              Invoke-RestMethod -Uri "http://127.0.0.1:$port/health" -TimeoutSec 2 | Out-Null
              $ready = $true
            } catch {
              try {
                # Fallback: if /openapi.json is reachable, consider server "ready"
                Invoke-RestMethod -Uri "http://127.0.0.1:$port/openapi.json" -TimeoutSec 2 | Out-Null
                $ready = $true
              } catch { $ready = $false }
            }
            if ($ready) { $ok = $true; break }

            # If the process died, dump logs and fail fast
            try {
              $proc = Get-Process -Id $apiPid -ErrorAction SilentlyContinue
              if (-not $proc) {
                Write-Host "API process ended while waiting."
                if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
                if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
                throw "API terminated before readiness."
              }
            } catch {}
            Start-Sleep -Seconds 1
          }
          if (-not $ok) {
            Write-Host "Timed out waiting for API on port $port"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to become ready on port $port"
          }

      - name: /health and /score smoke
        run: |
          $port = (Get-Content api_port.txt) -replace 'port=',''
          # /health best-effort (don't fail if not present)
          try {
            $null = Invoke-RestMethod -Uri "http://127.0.0.1:$port/health" -Method GET -TimeoutSec 5
            Write-Host "OK /health"
          } catch { Write-Host "WARN: /health not present or non-200."; }

          # Try /score with a generic payload; if 422 and STRICT_API_SMOKE=0, log and continue
          $body = @{
            amount = 120.5
            account_age_days = 200
            country = "US"
            device_id = "D_A"
            hour_of_day = 20
          } | ConvertTo-Json

          try {
            $resp = Invoke-RestMethod -Method Post -Uri "http://127.0.0.1:$port/score" -ContentType "application/json" -Body $body -TimeoutSec 15
            if (-not $resp) { throw "Empty /score response" }
            if (-not ($resp.PSObject.Properties.Name -contains "decision")) { throw "Missing 'decision' in /score response" }
            $probKey = @("proba","prob","score","p_fraud","fraud_proba","model_score") | Where-Object { $resp.PSObject.Properties.Name -contains $_ } | Select-Object -First 1
            if (-not $probKey) { throw "Missing probability-like key in /score response" }
            $p = [double]$resp.$probKey
            if ($p -lt 0 -or $p -gt 1) { throw "Probability out of range: $p" }
            Write-Host "OK /score â€” decision=$($resp.decision) $probKey=$p"
          } catch {
            if ($env:STRICT_API_SMOKE -eq "0") {
              Write-Host "WARN: /score smoke failed but STRICT_API_SMOKE=0. Continuing."
              Write-Host $_.Exception.Message
            } else {
              throw
            }
          }

      - name: Stop API (always)
        if: always()
        run: |
          if (Test-Path api_pid.txt) {
            $apiPid = ((Get-Content api_pid.txt) -replace 'pid=','')
            Try { Stop-Process -Id $apiPid -Force -ErrorAction SilentlyContinue } Catch {}
            Remove-Item api_pid.txt -ErrorAction SilentlyContinue
          }
          if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
          if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }

      - name: Upload API logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fraud-api-logs
          path: |
            api_stdout.txt
            api_stderr.txt
            api_pid.txt
            api_port.txt
          if-no-files-found: ignore
          retention-days: 7

  stage5-monitor-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install deps (monitoring)
        run: |
          python -m pip install --upgrade pip wheel
          pip install pandas numpy matplotlib evidently mlflow

      - name: Credit monitor (dry)
        run: |
          python shared_env/monitoring/monitor_credit_drift.py --dry-run

      - name: Fraud monitor (dry)
        run: |
          python shared_env/monitoring/monitor_fraud_api_logs.py --dry-run

      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artifacts
          path: |
            docs_global/monitoring/**/*
          if-no-files-found: ignore
          retention-days: 7
