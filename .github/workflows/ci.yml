name: ci

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Install CI deps
        run: |
          python -m pip install --upgrade pip wheel
          if (Test-Path "requirements-ci.txt") {
            pip install -r requirements-ci.txt
          } else {
            pip install pandas numpy evidently
          }

      - name: Show workspace + data
        run: |
          echo "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          ls
          if (Test-Path "data") { Get-ChildItem -Recurse -Force data | Select-Object FullName }

      - name: Run validation dry-run
        run: |
          python shared_env/scripts/validate_sample_evidently.py

  fraud-api-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
      # Keep schema checks lenient while stabilizing. Flip to "1" later to enforce.
      STRICT_API_SMOKE: "0"
      # Ensure local loopback skips any proxy
      NO_PROXY: "127.0.0.1,localhost"
      no_proxy: "127.0.0.1,localhost"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (API)
        run: |
          pip install fastapi uvicorn[standard] requests joblib pandas pydantic shap pytest pyyaml xgboost scikit-learn

      - name: Health check artifacts (UTF-8)
        run: |
          python -X utf8 shared_env/scripts/health_checks_stage4_fraud_api.py

      - name: Detect API port from run_api.py (default 8001)
        id: detect_port
        run: |
          $txt = Get-Content "fraud_detection_system/api/run_api.py" -Raw
          $m = [regex]::Match($txt, 'port\s*=\s*(\d+)')
          if ($m.Success) { $port = [int]$m.Groups[1].Value } else { $port = 8001 }
          "port=$port" | Out-File -FilePath api_port.txt -Encoding ascii
          Write-Host "Using port $port"

      - name: Launch API (uvicorn, no reload) with logs
        id: launch_api
        run: |
          $env:PYTHONUNBUFFERED = "1"
          $port = (Get-Content api_port.txt) -replace 'port=',''
          $args = "-m uvicorn fraud_detection_system.api.app:app --host 127.0.0.1 --port $port --log-level info"
          $p = Start-Process -FilePath "python" -ArgumentList $args -PassThru -NoNewWindow `
               -RedirectStandardOutput api_stdout.txt -RedirectStandardError api_stderr.txt
          "pid=$($p.Id)" | Out-File -FilePath api_pid.txt -Encoding ascii
          Start-Sleep -Seconds 1
          if ($p.HasExited) {
            Write-Host "API process exited early with code $($p.ExitCode)"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to start"
          }

      - name: Wait for readiness (Python, up to 120s; /health OR /openapi.json OR /docs OR /)
        run: |
          python - <<'PY'
          import os, sys, time
          import requests

          port = int(open('api_port.txt','r').read().split('=')[1].strip())
          base = f"http://127.0.0.1:{port}"
          paths = ["/health", "/openapi.json", "/docs", "/"]
          deadline = time.time() + 120
          ok = False
          # bypass proxies for loopback explicitly
          s = requests.Session()
          s.trust_env = False

          last_err = None
          while time.time() < deadline and not ok:
            for p in paths:
              url = base + p
              try:
                r = s.get(url, timeout=2)
                # consider any HTTP response under 500 as "service reachable"
                if r.status_code < 500:
                  print(f"Ready via {url} (HTTP {r.status_code})")
                  ok = True
                  break
              except Exception as e:
                last_err = e
            if not ok:
              time.sleep(1)

          if not ok:
            print("Timed out waiting for readiness.", "Last error:", repr(last_err))
            # show log tails if present
            try:
              with open("api_stderr.txt","r",encoding="utf-8",errors="replace") as f:
                lines = f.readlines()[-200:]
                print("--- api_stderr.txt (tail) ---"); print("".join(lines))
            except Exception: pass
            try:
              with open("api_stdout.txt","r",encoding="utf-8",errors="replace") as f:
                lines = f.readlines()[-200:]
                print("--- api_stdout.txt (tail) ---"); print("".join(lines))
            except Exception: pass
            sys.exit(1)
          PY

      - name: /health (best-effort) and /score smoke (Python)
        run: |
          python - <<'PY'
          import json, os, sys, requests
          port = int(open('api_port.txt','r').read().split('=')[1].strip())
          base = f"http://127.0.0.1:{port}"
          s = requests.Session(); s.trust_env = False

          # /health (best-effort)
          try:
            rh = s.get(base + "/health", timeout=5)
            print("Health HTTP", rh.status_code)
          except Exception as e:
            print("WARN: /health error:", repr(e))

          body = {
              "amount": 120.5,
              "account_age_days": 200,
              "country": "US",
              "device_id": "D_A",
              "hour_of_day": 20
          }
          strict = os.getenv("STRICT_API_SMOKE","0") == "1"
          try:
            rs = s.post(base + "/score", json=body, timeout=15)
            code = rs.status_code
            print("Score HTTP", code)
            if code == 200:
              resp = rs.json()
              open("score_resp.json","w",encoding="utf-8").write(json.dumps(resp, indent=2))
              has_dec = "decision" in resp
              has_prob = any(k in resp for k in ("proba","prob","score","p_fraud","fraud_proba","model_score"))
              if strict and (not has_dec or not has_prob):
                print("ERROR: missing 'decision' or probability-like field in /score")
                sys.exit(1)
            else:
              msg = f"/score non-200 ({code})"
              if strict:
                print("ERROR:", msg); sys.exit(1)
              else:
                print("WARN:", msg)
          except Exception as e:
            if strict:
              print("ERROR: /score exception:", repr(e)); sys.exit(1)
            else:
              print("WARN: /score exception:", repr(e))
          PY

      - name: Stop API (always)
        if: always()
        run: |
          if (Test-Path api_pid.txt) {
            $apiPid = ((Get-Content api_pid.txt) -replace 'pid=','')
            Try { Stop-Process -Id $apiPid -Force -ErrorAction SilentlyContinue } Catch {}
            Remove-Item api_pid.txt -ErrorAction SilentlyContinue
          }
          if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
          if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }

      - name: Upload API logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fraud-api-logs
          path: |
            api_stdout.txt
            api_stderr.txt
            api_pid.txt
            api_port.txt
            score_resp.json
          if-no-files-found: ignore
          retention-days: 7

  stage5-monitor-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install deps (monitoring)
        run: |
          python -m pip install --upgrade pip wheel
          pip install pandas numpy matplotlib evidently mlflow

      - name: Credit monitor (dry)
        run: |
          python shared_env/monitoring/monitor_credit_drift.py --dry-run

      - name: Fraud monitor (dry)
        run: |
          python shared_env/monitoring/monitor_fraud_api_logs.py --dry-run

      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artifacts
          path: |
            docs_global/monitoring/**/*
          if-no-files-found: ignore
          retention-days: 7
