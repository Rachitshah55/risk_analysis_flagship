name: ci

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Install CI deps
        run: |
          python -m pip install --upgrade pip wheel
          if (Test-Path "requirements-ci.txt") {
            pip install -r requirements-ci.txt
          } else {
            pip install pandas numpy evidently
          }

      - name: Show workspace + data
        run: |
          echo "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          ls
          if (Test-Path "data") { Get-ChildItem -Recurse -Force data | Select-Object FullName }

      - name: Run validation dry-run
        run: |
          python shared_env/scripts/validate_sample_evidently.py

  fraud-api-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
      # Keep schema checks lenient while stabilizing (set to "1" later to enforce /score shape strictly)
      STRICT_API_SMOKE: "0"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (API)
        run: |
          pip install fastapi uvicorn[standard] requests joblib pandas pydantic shap pytest pyyaml xgboost scikit-learn

      - name: Health check artifacts (UTF-8)
        run: |
          python -X utf8 shared_env/scripts/health_checks_stage4_fraud_api.py

      - name: Detect API port from run_api.py (default 8001)
        id: detect_port
        run: |
          $txt = Get-Content "fraud_detection_system/api/run_api.py" -Raw
          $m = [regex]::Match($txt, 'port\s*=\s*(\d+)')
          if ($m.Success) { $port = [int]$m.Groups[1].Value } else { $port = 8001 }
          "port=$port" | Out-File -FilePath api_port.txt -Encoding ascii
          Write-Host "Using port $port"

      - name: Launch API (uvicorn, no reload) with logs
        id: launch_api
        run: |
          $env:PYTHONUNBUFFERED = "1"
          $port = (Get-Content api_port.txt) -replace 'port=',''
          $args = "-m uvicorn fraud_detection_system.api.app:app --host 127.0.0.1 --port $port --log-level info"
          $p = Start-Process -FilePath "python" -ArgumentList $args -PassThru -NoNewWindow `
               -RedirectStandardOutput api_stdout.txt -RedirectStandardError api_stderr.txt
          "pid=$($p.Id)" | Out-File -FilePath api_pid.txt -Encoding ascii
          Start-Sleep -Seconds 1
          if ($p.HasExited) {
            Write-Host "API process exited early with code $($p.ExitCode)"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to start"
          }

      - name: Wait for readiness (up to 120s; /health OR /openapi.json OR /docs OR /)
        run: |
          $port = (Get-Content api_port.txt) -replace 'port=',''
          $ok = $false
          $paths = @("health","openapi.json","docs","")
          for ($i=0; $i -lt 120; $i++) {
            foreach ($p in $paths) {
              $u = "http://127.0.0.1:$port/" + $p
              & curl.exe --noproxy 127.0.0.1 -sS -m 2 -o NUL $u
              if ($LASTEXITCODE -eq 0) { $ok = $true; break }
            }
            if ($ok) { break }
            Start-Sleep -Seconds 1
          }
          if (-not $ok) {
            Write-Host "Timed out waiting for API on port $port"
            if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
            if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }
            throw "API failed to become ready on port $port"
          }
          Write-Host "API readiness OK."

      - name: /health (best-effort) and /score smoke
        run: |
          $port = (Get-Content api_port.txt) -replace 'port=',''

          # /health best-effort
          try {
            & curl.exe --noproxy 127.0.0.1 -sS -m 5 -o NUL "http://127.0.0.1:$port/health"
            if ($LASTEXITCODE -eq 0) { Write-Host "OK /health" } else { Write-Host "WARN: /health non-200 or missing." }
          } catch { Write-Host "WARN: /health probe error." }

          # /score with a simple payload
          $body = '{"amount":120.5,"account_age_days":200,"country":"US","device_id":"D_A","hour_of_day":20}'
          $resp = & curl.exe --noproxy 127.0.0.1 -sS -m 15 -H "Content-Type: application/json" -d $body "http://127.0.0.1:$port/score"
          $code = $LASTEXITCODE
          if ($code -eq 0) {
            $resp | Out-File -FilePath score_resp.json -Encoding utf8
            $hasDecision = ($resp -match '"decision"\s*:')
            $hasProb = ($resp -match '"(proba|prob|score|p_fraud|fraud_proba|model_score)"\s*:')
            if (-not $hasDecision -or -not $hasProb) {
              if ($env:STRICT_API_SMOKE -eq "1") { throw "Missing decision or probability in /score response" }
              else { Write-Host "WARN: /score response lacks expected keys; continuing (STRICT_API_SMOKE=0)." }
            } else {
              Write-Host "OK /score payload shape looks good."
            }
          } else {
            if ($env:STRICT_API_SMOKE -eq "1") { throw "ERROR: /score returned non-200 (curl exit $code)" }
            else { Write-Host "WARN: /score failed but STRICT_API_SMOKE=0; continuing." }
          }

      - name: Stop API (always)
        if: always()
        run: |
          if (Test-Path api_pid.txt) {
            $apiPid = ((Get-Content api_pid.txt) -replace 'pid=','')
            Try { Stop-Process -Id $apiPid -Force -ErrorAction SilentlyContinue } Catch {}
            Remove-Item api_pid.txt -ErrorAction SilentlyContinue
          }
          if (Test-Path api_stdout.txt) { Write-Host "--- api_stdout.txt (tail) ---"; Get-Content api_stdout.txt -Tail 200 }
          if (Test-Path api_stderr.txt) { Write-Host "--- api_stderr.txt (tail) ---"; Get-Content api_stderr.txt -Tail 200 }

      - name: Upload API logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fraud-api-logs
          path: |
            api_stdout.txt
            api_stderr.txt
            api_pid.txt
            api_port.txt
            score_resp.json
          if-no-files-found: ignore
          retention-days: 7

  stage5-monitor-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install deps (monitoring)
        run: |
          python -m pip install --upgrade pip wheel
          pip install pandas numpy matplotlib evidently mlflow

      - name: Credit monitor (dry)
        run: |
          python shared_env/monitoring/monitor_credit_drift.py --dry-run

      - name: Fraud monitor (dry)
        run: |
          python shared_env/monitoring/monitor_fraud_api_logs.py --dry-run

      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-artifacts
          path: |
            docs_global/monitoring/**/*
          if-no-files-found: ignore
          retention-days: 7
