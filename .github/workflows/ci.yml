name: ci
on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  validate:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install CI deps
        run: |
          pip install -r requirements-ci.txt
          # Ensure Evidently matches project standard (avoid 0.4.x legacy imports)
          pip install "evidently>=0.7,<0.8"

      - name: Show workspace + data
        run: |
          echo "GITHUB_WORKSPACE=$env:GITHUB_WORKSPACE"
          ls
          if (Test-Path "data") { Get-ChildItem -Recurse -Force data | Select-Object FullName }

      - name: Run validation dry-run
        run: |
          python shared_env/scripts/validate_sample_evidently.py

  fraud-api-smoke:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (API)
        run: |
          pip install fastapi uvicorn[standard] requests joblib pandas pydantic shap pytest pyyaml

      - name: Health check artifacts (UTF-8)
        run: |
          python -X utf8 shared_env/scripts/health_checks_stage4_fraud_api.py

      - name: Launch API (background)
        id: launch_api
        run: |
          $p = Start-Process -FilePath "python" -ArgumentList "fraud_detection_system/api/run_api.py" -PassThru
          "pid=$($p.Id)" | Out-File -FilePath api_pid.txt

      - name: Detect API port from run_api.py
        id: detect_port
        run: |
          $txt = Get-Content "fraud_detection_system/api/run_api.py" -Raw
          $m = [regex]::Match($txt, 'port\s*=\s*(\d+)')
          if ($m.Success) { $port = [int]$m.Groups[1].Value } else { $port = 8000 }
          echo "port=$port" | Out-File -FilePath api_port.txt
          Write-Host "Using port $port"

      - name: Wait for readiness
        run: |
          $port = (Get-Content api_port.txt) -replace 'port=',''
          $ok = $false
          for ($i=0; $i -lt 40; $i++) {
            try {
              Invoke-RestMethod -Uri "http://127.0.0.1:$port/health" -TimeoutSec 2 | Out-Null
              $ok = $true; break
            } catch { Start-Sleep -Milliseconds 500 }
          }
          if (-not $ok) { throw "API failed to become ready on port $port" }

      - name: /health and /score smoke
        run: |
          $port = (Get-Content api_port.txt) -replace 'port=',''
          # /health
          $health = Invoke-RestMethod -Uri "http://127.0.0.1:$port/health" -Method GET -TimeoutSec 5
          if (-not $health) { throw "Empty /health response" }
          # /score
          $body = @{
            amount = 120.5
            account_age_days = 200
            country = "US"
            device_id = "D_A"
            hour_of_day = 20
          } | ConvertTo-Json
          $resp = Invoke-RestMethod -Method Post -Uri "http://127.0.0.1:$port/score" -ContentType "application/json" -Body $body -TimeoutSec 10
          if (-not $resp) { throw "Empty /score response" }
          if (-not ($resp.PSObject.Properties.Name -contains "decision")) { throw "Missing 'decision' in /score response" }
          $probKey = @("proba","prob","score","p_fraud","fraud_proba","model_score") | Where-Object { $resp.PSObject.Properties.Name -contains $_ } | Select-Object -First 1
          if (-not $probKey) { throw "Missing probability-like key in /score response" }
          $p = [double]$resp.$probKey
          if ($p -lt 0 -or $p -gt 1) { throw "Probability out of range: $p" }
          Write-Host "✅ /score OK — decision=$($resp.decision) $probKey=$p"

      - name: Stop API
        if: always()
        run: |
          if (Test-Path api_pid.txt) {
            $pidLine = Get-Content api_pid.txt | Select-Object -First 1
            $pid = ($pidLine -split "=")[1]
            Try { Stop-Process -Id $pid -Force -ErrorAction SilentlyContinue } Catch {}
            Remove-Item api_pid.txt -ErrorAction SilentlyContinue
          }
              
  stage5-monitor-smoke:
    name: Stage 5 Monitor Smoke (dry-run, Python 3.13)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Show Python
        run: |
          python --version
          python -m pip --version

      - name: Upgrade pip tooling
        run: |
          python -m pip install --upgrade pip wheel

      - name: Install deps (monitoring only)
        run: |
          pip install pandas numpy matplotlib "evidently>=0.7,<0.8" mlflow pyarrow scikit-learn xgboost

      - name: Credit monitor (dry-run)
        run: |
          python shared_env/monitoring/monitor_credit_drift.py --dry-run

      - name: Fraud monitor (dry-run)
        run: |
          python shared_env/monitoring/monitor_fraud_api_logs.py --dry-run

      - name: Upload monitoring artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stage5-monitoring-artifacts
          path: |
            docs_global/monitoring/**
          if-no-files-found: warn

